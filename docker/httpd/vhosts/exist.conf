<VirtualHost *:80>

    ProxyTimeout 3000000
    RewriteEngine on

    RewriteRule ^/openapi/$ /openapi/index.html [R=301,NC,L]
    RewriteRule ^/openapi$ /openapi/index.html [R=301,NC,L]

    RewriteCond %{QUERY_STRING} _query=
    RewriteRule      (.*)               $1?     [R=permanent]
    
    Header always set Referrer-Policy "no-referrer"

  <Location /exist/ >
      ProxyPreserveHost Off
      ProxyPass http://existdb:8080/exist/ retry=0
      ProxyPassReverse http://existdb:8080/exist/
  </Location>

  <Location /sade/ >
      ProxyPreserveHost Off
      ProxyPass http://existdb:8080/exist/apps/sade/ retry=0
      ProxyPassReverse http://existdb:8080/exist/apps/sade/
  </Location>

  <Location /rest/ >
      ProxyPreserveHost Off
      ProxyPass http://existdb:8080/exist/rest/db/ retry=0
      ProxyPassReverse http://existdb:8080/exist/rest/db/
  </Location>

  <Location /api/ >
      ProxyPreserveHost Off
      ProxyPass http://existdb:8080/exist/restxq/ retry=0
      ProxyPassReverse http://existdb:8080/exist/restxq/
      Require all granted
      Header set Access-Control-Allow-Origin "*"
  </Location>

  <Location /openapi/>
  # there is a corresponding redirect for index.html, see above
      ProxyPreserveHost Off
      ProxyPass http://existdb:8080/exist/apps/ahikar/openapi/ retry=0
      ProxyPassReverse http://existdb:8080/exist/apps/ahikar/openapi/
      Require all granted
      Header set Access-Control-Allow-Origin "*"
  </Location>

  <Location /metrics/exist >
      ProxyPreserveHost Off
      ProxyPass http://existdb:8079/metrics retry=0
      ProxyPassReverse http://existdb:8079/metrics
      Require all granted
  </Location>

  <Location /metrics/httpd >
      ProxyPreserveHost Off
      ProxyPass http://httpd-prometheus:9117/metrics retry=0
      ProxyPassReverse http://httpd-prometheus:9117/metrics
      Require all granted
  </Location>

  <Location "/server-status">
      SetHandler server-status
      Require all granted
  </Location>

</VirtualHost>
